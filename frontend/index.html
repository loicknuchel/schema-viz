<!doctype html>
<html lang="en">
<head>
    <title>Schema Viz</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    <link rel="manifest" href="assets/site.webmanifest">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript">
        window.onload = function () {
            const app = Elm.Main.init({
                node: document.getElementById("elm-app"),
                flags: null
            })

            // bootstrap ports
            app.ports.activateTooltipsAndPopovers.subscribe(() => {
                // a ugly hack to avoid race conditions
                // elements are rendered and selected in the same time, so sometimes, it's called before rendering and cause errors :(
                setTimeout(function () {
                    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e => bootstrap.Tooltip.getOrCreateInstance(e))
                    document.querySelectorAll('[data-bs-toggle="popover"]').forEach(e => bootstrap.Popover.getOrCreateInstance(e))
                }, 100)
            })
            // autofocus element in modal that require it (not done automatically)
            // cd https://getbootstrap.com/docs/5.0/components/modal/: "Due to how HTML5 defines its semantics, the autofocus HTML attribute has no effect in Bootstrap modals."
            window.addEventListener('shown.bs.modal', function (e) {
                e.target.querySelector('[autofocus]').focus()
            })
            // hide tooltip on click (avoid orphan tooltips when element is removed)
            // cf https://getbootstrap.com/docs/5.0/components/tooltips/: "Tooltips must be hidden before their corresponding elements have been removed from the DOM."
            let currentTooltip = null
            window.addEventListener('show.bs.tooltip', function (e) {
                currentTooltip = e.target
            })
            window.addEventListener('click', function () {
                currentTooltip && bootstrap.Tooltip.getOrCreateInstance(currentTooltip).hide()
            })

            // resize ports
            app.ports.observeSizes.subscribe(ids => {
                setTimeout(function () {
                    ids.forEach(id => resizeObserver.observe(document.getElementById(id)))
                }, 100)
            })
            const resizeObserver = new ResizeObserver(entries => {
                const sizes = entries.map(entry => ({
                    id: entry.target.id,
                    size: {
                        width: entry.contentRect.width,
                        height: entry.contentRect.height
                    }
                }))
                app.ports.sizesReceiver.send(sizes)
            })
        };
    </script>
</head>
<body>
<div id="elm-app"></div>
</body>
</html>
