<!doctype html>
<html lang="en">
<head>
    <title>Schema Viz</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
    <link rel="manifest" href="assets/site.webmanifest">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="index.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript">
        window.onload = function () {
            const app = Elm.Main.init({
                node: document.getElementById("elm-app"),
                flags: null
            })


            /* Elm ports */

            function sendToElm(msg) {
                // console.log('js message', msg)
                app.ports.jsToElm.send(msg)
            }
            app.ports.elmToJs.subscribe(msg => {
                // setTimeout: a ugly hack to wait for Elm to render the model changes before running the commands :(
                setTimeout(function () {
                    // console.log('elm message', msg)
                    switch (msg.kind) {
                        case "Click":         click(msg.id); break;
                        case "ShowModal":     showModal(msg.id); break;
                        case "HideModal":     hideModal(msg.id); break;
                        case "HideOffcanvas": hideOffcanvas(msg.id); break;
                        case "ActivateTooltipsAndPopovers": activateTooltipsAndPopovers(); break;
                        case "ShowToast":     showToast(msg.toast); break;
                        case "LoadSchemas":   loadSchemas(); break;
                        case "SaveSchema":    saveSchema(msg.schema); break;
                        case "DropSchema":    dropSchema(msg.schema); break;
                        case "ReadFile":      readFile(msg.file); break;
                        case "ObserveSizes":  observeSizes(msg.ids); break;
                        default: console.error('Unsupported Elm message', msg); break;
                    }
                }, 100)
            })

            function click(id) {
                document.getElementById(id).click()
            }
            function showModal(id) {
                bootstrap.Modal.getOrCreateInstance(document.getElementById(id)).show()
            }
            function hideModal(id) {
                bootstrap.Modal.getOrCreateInstance(document.getElementById(id)).hide()
            }
            function hideOffcanvas(id) {
                bootstrap.Offcanvas.getOrCreateInstance(document.getElementById(id)).hide()
            }
            function activateTooltipsAndPopovers() {
                document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(e => bootstrap.Tooltip.getOrCreateInstance(e))
                document.querySelectorAll('[data-bs-toggle="popover"]').forEach(e => bootstrap.Popover.getOrCreateInstance(e))
            }

            let toastCpt = 0
            const toastContainer = document.getElementById('toast-container')
            function showToast(toast) {
                const toastNo = toastCpt += 1
                const toastId = 'toast-' + toastNo
                let html =
                    '<div class="toast align-items-center" id="' + toastId + '" role="status" aria-live="polite" aria-atomic="true">\n' +
                    '  <div class="d-flex">\n' +
                    '    <div class="toast-body">\n' +
                    '      ' + toast.message + '\n' +
                    '    </div>\n' +
                    '    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>\n' +
                    '  </div>\n' +
                    '</div>'
                if (toast.kind === 'error') {
                    html =
                        '<div class="toast align-items-center bg-danger text-white" id="' + toastId + '" role="status" aria-live="polite" aria-atomic="true" data-bs-autohide="false">\n' +
                        '  <div class="d-flex">\n' +
                        '    <div class="toast-body">\n' +
                        '      ' + toast.message + '\n' +
                        '    </div>\n' +
                        '    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>\n' +
                        '  </div>\n' +
                        '</div>'
                }
                toastContainer.insertAdjacentHTML('beforeend', html);
                bootstrap.Toast.getOrCreateInstance(document.getElementById(toastId)).show()
            }

            const schemaPrefix = 'schema-'
            function loadSchemas() {
                const values = Object.keys(localStorage)
                    .filter(key => key.startsWith(schemaPrefix))
                    .map(key => [key.replace(schemaPrefix, ''), JSON.parse(localStorage.getItem(key))])
                sendToElm({kind: "SchemasLoaded", schemas: values})
            }
            function saveSchema(schema) {
                const key = schemaPrefix + schema.id
                // setting dates should be done in Elm but can't find how to run a Task before calling a Port
                const now = Date.now()
                schema.info.updated = now
                if (localStorage.getItem(key) == null) { schema.info.created = now }
                localStorage.setItem(key, JSON.stringify(schema))
            }
            function dropSchema(schema) {
                localStorage.removeItem(schemaPrefix + schema.id)
            }

            function readFile(file) {
                const reader = new FileReader()
                reader.onload = e => sendToElm({kind: "FileRead", now: Date.now(), file: file, content: e.target.result})
                reader.readAsText(file)
            }

            const resizeObserver = new ResizeObserver(entries => {
                const sizes = entries.map(entry => ({
                    id: entry.target.id,
                    size: {
                        width: entry.contentRect.width,
                        height: entry.contentRect.height
                    }
                }))
                sendToElm({kind: "SizesChanged", sizes: sizes})
            })
            function observeSizes(ids) {
                ids.forEach(id => resizeObserver.observe(document.getElementById(id)))
            }


            /* Bootstrap helpers */

            // hide tooltip on click (avoid orphan tooltips when element is removed)
            // cf https://getbootstrap.com/docs/5.0/components/tooltips/: "Tooltips must be hidden before their corresponding elements have been removed from the DOM."
            let currentTooltip = null
            window.addEventListener('show.bs.tooltip', function (e) {
                currentTooltip = e.target
            })
            window.addEventListener('click', function () {
                currentTooltip && bootstrap.Tooltip.getOrCreateInstance(currentTooltip).hide()
            })
            // autofocus element in modal that require it (not done automatically)
            // cd https://getbootstrap.com/docs/5.0/components/modal/: "Due to how HTML5 defines its semantics, the autofocus HTML attribute has no effect in Bootstrap modals."
            window.addEventListener('shown.bs.modal', function (e) {
                const input = e.target.querySelector('[autofocus]')
                input && input.focus()
                activateTooltipsAndPopovers()
            })
            window.addEventListener('hidden.bs.toast', function (e) {
                const toast = document.getElementById(e.target.id)
                toast.parentNode.removeChild(toast)
            })
        }
    </script>
</head>
<body>
<div id="elm-app"></div>
</body>
</html>
